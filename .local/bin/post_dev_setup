#!/usr/bin/env bash

export PATH="$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:$PATH"

echo "Installing Nix packages..."
nix-env -f $HOME/.config/nix/default.nix --install
export LD_LIBRARY_PATH="$HOME/.nix-profile/lib:$HOME/.nix-profile/lib64"
ncurses_path=$(nix-build '<nixpkgs>' -A ncurses.dev --no-out-link)
export LIBRARY_PATH="${ncurses_path}/lib:${LIBRARY_PATH}"
export CPPFLAGS="-I${ncurses_path}/include ${CPPFLAGS}"
export LDFLAGS="-L${ncurses_path}/lib ${LDFLAGS}"
echo "Install complete"

# Setup Github
if command -v gh &> /dev/null
then
	echo "Setting up GitHub..."
	read -p "Enter github config user.email: " email
	read -p "Enter github config user.name: " username
	if [ ! -z "$email" ] && [ ! -z "$username" ]
	then
		git config --global user.email "$email"
		git config --global user.name "$username"
	fi
	gh auth login
fi

echo "Setting up bare repo"
#git clone --bare https://github.com/linkinlog/.dotfiles $HOME/.dotfiles
#git --git-dir=$HOME/.dotfiles/ --work-tree=$HOME checkout
git --git-dir=$HOME/.dotfiles/ --work-tree=$HOME submodule update --init --remote


# Setup Python3 for nvim and thefuck for zsh
if command -v python3 &> /dev/null
then
	echo "Insalling python deps..."
    pip3 install neovim
fi

# Setup binutils 2.40 from source for ncurses
wget https://ftp.gnu.org/gnu/binutils/binutils-2.40.tar.gz
tar xzf binutils-2.40.tar.gz
cd binutils-2.40
./configure --prefix=/opt/binutils
make && sudo make install
cd

# Setup ncurses 6.4 from source for zsh
wget https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.4.tar.gz
tar xzf ncurses-6.4.tar.gz
cd ncurses-6.4
./configure --prefix=/opt/ncurses
make && sudo make install
cd

# Setup zsh from source
echo "Building zsh"
git clone https://github.com/zsh-users/zsh $HOME/zsh
cd $HOME/zsh
./Util/preconfig
./configure
make
make check && sudo make install
cd -

# Setup ohmyzsh
if command -v zsh &> /dev/null
then
	echo "Setting up OhMyZsh"
	export RUNZSH=no
	export KEEP_ZSHRC=yes
	sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
	git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
	git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
	echo "OhMyZsh installed and configured, run zsh now"
fi

echo "Local dev setup finished hopefully!"
